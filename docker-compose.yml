services:
  
  backend1:
    container_name: backend1
    ports:
      - "8081:8080"
      - "2021:22"
    networks:
      - my-network
    build: backend1/ 

  backend2:
    container_name: backend2
    ports:
      - "8082:8080"
      - "2022:22"
    networks: 
      - my-network
    build: backend2

  lb1:
    container_name: lb1
    ports:
      - "80:80"
      - "2023:22"
    networks:
      - my-network
    build: lb1/
  
  lb2:
    container_name: lb2
    ports:
      - "81:80"
      - "2024:22"
    networks: 
      - my-network
    build: lb2/

  ansible:
    build: ansible/
    container_name: ansible
    networks:
        - my-network
    volumes:
      - ./ansible/playbooks:/ansible/playbooks/
      - /var/run/docker.sock:/var/run/docker.sock
    entrypoint: ["/bin/sh", "-c", "ansible-playbook /ansible/playbooks/playbook_main.yml &&  ansible-playbook /ansible/playbooks/playbook_conf-lb.yml &&  ansible-playbook /ansible/playbooks/playbook_conf-cluster-lb.yml &&  ansible-playbook /ansible/playbooks/playbook_conf-backend.yml"]
    depends_on: 
      - backend1 
      - backend2 
      - lb1 
      - lb2

networks:
  my-network:
    driver: bridge
    internal: true

